<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظرسنجی هوشمند کسب‌وکارها - Puzzle Net</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Vazirmatn for Persian UI) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #111827; /* gray-900 */
        }
        .chart-container {
            position: relative;
            height: 35vh;
            width: 100%;
        }
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
        .has-[:checked]:border-purple-500 { border-color: #a855f7; }
        .has-[:checked]:border-yellow-500 { border-color: #eab308; }
        .has-[:checked]:border-red-500 { border-color: #ef4444; }
        .has-[:checked]:border-blue-500 { border-color: #3b82f6; }
        .spinner {
            width: 24px;
            height: 24px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

    </style>
</head>
<body class="text-gray-200">

    <!-- Config Error Banner -->
    <div id="config-error-banner" class="hidden bg-red-600 text-white text-center p-4 fixed top-0 w-full z-50">
        <h3 class="font-bold text-lg">خطای پیکربندی!</h3>
        <p>اطلاعات اتصال به پایگاه داده (Firebase) در کد موجود نیست. لطفاً مقادیر موجود در متغیر <code>firebaseConfig</code> را با اطلاعات واقعی پروژه خود در <a href="https://console.firebase.google.com/" target="_blank" class="underline hover:text-yellow-300">کنسول Firebase</a> جایگزین کنید تا برنامه به درستی کار کند.</p>
    </div>


    <!-- Header -->
    <header class="bg-gray-800/50 backdrop-blur-sm shadow-lg sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <h1 class="text-2xl font-black text-purple-400">Puzzle Net ✨ AI</h1>
            <div>
                <button id="show-form-btn" class="px-4 py-2 text-white bg-purple-600 rounded-md hover:bg-purple-700 transition-colors focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-gray-900">فرم نظرسنجی</button>
                <button id="show-stats-btn" class="px-4 py-2 text-white bg-gray-700 rounded-md hover:bg-gray-600 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-900 mr-2">آمار هوشمند</button>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 md:p-8 pt-16" id="main-content">

        <!-- Survey Form Section -->
        <section id="form-section">
             <div class="bg-gray-800 p-8 rounded-lg shadow-2xl max-w-4xl mx-auto border border-gray-700">
                <h2 class="text-3xl font-bold text-center mb-2 text-purple-400">نظرسنجی بزرگ کسب‌وکارهای آنلاین</h2>
                 <h2 class="text-3xl font-bold text-center mb-2 text-purple-400">حتما در زمان ثبت رای فیلترشکن روشن باشد</h2>
                          <p class="text-center text-gray-400 mb-8">تأثیر محدودیت‌های اینترنتی بر رشد کسب‌وکارها</p>
                
                <form id="survey-form" class="space-y-6">
                    <!-- Job Field -->
                    <div>
                        <label for="job-field" class="block mb-2 text-sm font-bold text-gray-400">حوزه کاری شما (اجباری)</label>
                        <input type="text" id="job-field" name="job-field" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="مثال: فروشگاه آنلاین پوشاک، آموزش برنامه‌نویسی" required>
                    </div>

                    <!-- Damage Level -->
                    <div>
                        <label class="block mb-2 text-sm font-bold text-gray-400">میزان تخمینی خسارت مالی در یکسال گذشته (نسبت به شرایط بدون فیلترینگ)</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <label class="p-4 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 border-2 border-transparent has-[:checked]:border-blue-500 transition-all">
                                <input type="radio" name="damage-level" value="کم" class="hidden">
                                <span class="font-bold block text-center">کم</span>
                                <span class="text-xs text-gray-400 block text-center">تا ۱۰۰ میلیون تومان</span>
                            </label>
                            <label class="p-4 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 border-2 border-transparent has-[:checked]:border-yellow-500 transition-all">
                                <input type="radio" name="damage-level" value="متوسط" class="hidden" checked>
                                <span class="font-bold block text-center">متوسط</span>
                                <span class="text-xs text-gray-400 block text-center">۱۰۰ میلیون تا ۱ میلیارد تومان</span>
                            </label>
                            <label class="p-4 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 border-2 border-transparent has-[:checked]:border-red-500 transition-all">
                                <input type="radio" name="damage-level" value="زیاد" class="hidden">
                                <span class="font-bold block text-center">زیاد</span>
                                <span class="text-xs text-gray-400 block text-center">۱ میلیارد تا ۱۰ میلیارد تومان</span>
                            </label>
                            <label class="p-4 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 border-2 border-transparent has-[:checked]:border-purple-500 transition-all">
                                <input type="radio" name="damage-level" value="بسیار زیاد" class="hidden">
                                <span class="font-bold block text-center">بسیار زیاد</span>
                                <span class="text-xs text-gray-400 block text-center">بیش از ۱۰ میلیارد تومان</span>
                            </label>
                        </div>
                    </div>

                    <!-- Filtering Impact -->
                    <div>
                        <label for="filtering-impact" class="block mb-2 text-sm font-bold text-gray-400">اثر فیلترینگ روی رشد کسب و کار و شرایط مهاجرت</label>
                        <select id="filtering-impact" name="filtering-impact" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="کاهش رشد و تصمیم به مهاجرت">کاهش رشد و ایجاد تصمیم به مهاجرت</option>
                            <option value="کاهش رشد بدون تصمیم به مهاجرت">کاهش رشد بدون تصمیم به مهاجرت</option>
                            <option value="بی‌اثر">بی‌اثر بوده است</option>
                            <option value="رشد مثبت">باعث رشد مثبت شده است</option>
                        </select>
                    </div>

                    <!-- Location -->
                    <div>
                        <label for="province" class="block mb-2 text-sm font-bold text-gray-400">موقعیت مکانی شما</label>
                        <select id="province" name="province" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <!-- Province list will be populated by JS -->
                        </select>
                    </div>
                    
                    <!-- General Opinion -->
                    <div>
                        <label for="opinion" class="block mb-2 text-sm font-bold text-gray-400">نظر کلی شما (اختیاری)</label>
                        <textarea id="opinion" name="opinion" rows="5" maxlength="2500" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="نظر خود را در مورد شرایط فعلی و آینده بنویسید..."></textarea>
                        <p id="char-counter" class="text-xs text-gray-500 mt-1 text-left">0 / 2500</p>
                    </div>

                    <!-- Email for Uniqueness -->
                    <div>
                        <label for="email" class="block mb-2 text-sm font-bold text-gray-400">ایمیل شما (برای یکتاسازی رای - ارسال نخواهد شد)</label>
                        <input type="email" id="email" name="email" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 text-left" placeholder="example@email.com" required>
                    </div>

                    <!-- CAPTCHA -->
                    <div class="flex items-center">
                        <input id="captcha" type="checkbox" class="h-5 w-5 bg-gray-700 border-gray-600 rounded text-purple-600 focus:ring-purple-500 cursor-pointer">
                        <label for="captcha" class="mr-3 text-sm font-bold text-gray-400 cursor-pointer">من ربات نیستم.</label>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-purple-500 transition-transform transform hover:scale-105">
                        ارسال نظر و دریافت کد تأیید
                    </button>
                </form>
            </div>
        </section>

        <!-- Statistics Section -->
        <section id="stats-section" class="hidden">
            <div class="bg-gray-800 p-8 rounded-lg shadow-2xl max-w-7xl mx-auto border border-gray-700">
                <h2 class="text-3xl font-bold text-center mb-8 text-purple-400">آمار لحظه‌ای و تحلیل هوشمند</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                     <!-- Standard Charts -->
                    <div class="bg-gray-900/50 p-6 rounded-lg border border-gray-700">
                        <h3 class="text-xl font-bold mb-4 text-center">گزارش‌های آماری</h3>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-lg font-semibold mb-2 text-center text-gray-400">تفکیک میزان خسارت</h4>
                                <div class="chart-container">
                                    <canvas id="damage-chart"></canvas>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-lg font-semibold mb-2 text-center text-gray-400">تفکیک استانی</h4>
                                <div class="chart-container">
                                    <canvas id="province-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Analysis -->
                    <div class="bg-gray-900/50 p-6 rounded-lg border border-purple-500/30">
                        <h3 class="text-xl font-bold mb-4 text-center text-purple-300">✨ تحلیل هوش مصنوعی ✨</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                               <h4 class="text-lg font-semibold mb-2 text-center text-gray-400">تحلیل احساسات نظرات</h4>
                                <div class="chart-container">
                                    <canvas id="sentiment-chart"></canvas>
                                </div>
                            </div>
                             <div>
                                <h4 class="text-lg font-semibold mb-2 text-center text-gray-400">ابر کلمات کلیدی</h4>
                                <div id="tag-cloud" class="flex flex-wrap justify-center items-center gap-2 leading-relaxed p-4 min-h-[200px] h-full">
                                   <p class="text-gray-500">در حال بارگذاری کلمات...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Report Generation -->
                <div class="bg-gray-900/50 p-6 rounded-lg border border-gray-700 text-center">
                     <h3 class="text-xl font-bold mb-4 text-center text-purple-300">تولید گزارش با هوش مصنوعی</h3>
                     <p class="text-gray-400 mb-4 max-w-2xl mx-auto">با کلیک بر روی دکمه زیر، هوش مصنوعی Gemini خلاصه‌ای از نتایج نظرسنجی را تحلیل کرده و یک پیش‌نویس گزارش رسمی آماده می‌کند.</p>
                     <button id="generate-report-btn" class="bg-gradient-to-r from-purple-600 to-red-500 text-white font-bold py-3 px-8 rounded-md hover:from-purple-700 hover:to-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-purple-500 transition-all transform hover:scale-105 flex items-center justify-center mx-auto disabled:opacity-50 disabled:cursor-wait">
                        <span id="btn-text">✨ ایجاد پیش‌نویس گزارش رسمی</span>
                        <div id="btn-spinner" class="spinner hidden ml-3"></div>
                     </button>
                </div>

                 <p class="text-center mt-8 text-gray-500">تعداد کل شرکت‌کنندگان: <span id="total-participants" class="font-bold text-purple-400">0</span></p>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="text-center py-6 mt-12">
        <p class="text-gray-500">&copy; <span id="copyright-year"></span> Puzzle Net. کلیه حقوق محفوظ است.</p>
    </footer>
    
    <!-- Verification Modal -->
    <div id="verification-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
         <div class="bg-gray-800 rounded-lg shadow-xl p-8 max-w-sm w-full border border-gray-700">
            <h3 class="text-2xl font-bold text-purple-400 mb-4 text-center">تأیید هویت</h3>
            <p class="text-gray-400 mb-4 text-center">
                برای جلوگیری از ثبت رای تکراری، لطفاً کد زیر را در کادر وارد کنید.
            </p>
            <p class="text-center font-mono text-2xl bg-gray-900 text-yellow-400 p-3 rounded-md my-4 tracking-widest" id="verification-code-display"></p>
            
            <input type="text" id="verification-code-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 text-center text-2xl tracking-[0.5em]" placeholder="------" maxlength="6">
            
            <div id="timer" class="text-center my-4 text-lg font-bold text-red-500">05:00</div>
            
            <button id="verify-btn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-md hover:bg-purple-700 transition-colors">تأیید و ثبت نهایی</button>
            <button id="cancel-verify-btn" class="w-full mt-2 bg-gray-600 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-500 transition-colors">انصراف</button>
        </div>
    </div>
    
    <!-- Message Modal -->
    <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 max-w-sm w-full text-center border border-gray-700">
            <div id="message-icon" class="mx-auto mb-4"></div>
            <p id="message-text" class="text-lg font-semibold"></p>
            <button id="close-message-btn" class="mt-6 bg-purple-600 text-white font-bold py-2 px-6 rounded-md hover:bg-purple-700 transition-colors">بستن</button>
        </div>
    </div>
    
    <!-- AI Report Modal -->
    <div id="report-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 max-w-2xl w-full border border-purple-500/50 flex flex-col" style="height: 90vh;">
            <h3 class="text-2xl font-bold text-purple-400 mb-4 text-center">✨ پیش‌نویس گزارش تولید شده با هوش مصنوعی ✨</h3>
            <div id="report-content" class="flex-grow bg-gray-900/50 p-4 rounded-md overflow-y-auto whitespace-pre-wrap text-gray-300 border border-gray-700">
                در حال تولید گزارش...
            </div>
            <div class="mt-6 flex gap-4">
                <button id="copy-report-btn" class="flex-grow bg-green-600 text-white font-bold py-2 px-6 rounded-md hover:bg-green-700 transition-colors">کپی کردن متن</button>
                <button id="close-report-btn" class="flex-grow bg-gray-600 text-white font-bold py-2 px-6 rounded-md hover:bg-gray-500 transition-colors">بستن</button>
            </div>
        </div>
    </div>


    <!-- Firebase and App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // User's provided Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCOMh9xAmCperUJ6e9Z2wwDcUqqVHQihJ8",
            authDomain: "puzzlenet-survey.firebaseapp.com",
            projectId: "puzzlenet-survey",
            storageBucket: "puzzlenet-survey.appspot.com", // Corrected storageBucket format
            messagingSenderId: "1000378308851",
            appId: "1:1000378308851:web:e7712dbd6d622d43f8ff86",
            measurementId: "G-YCJHQ2ND14"
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            // --- ELEMENTS ---
            const form = document.getElementById('survey-form');
            const opinionTextarea = document.getElementById('opinion');
            const charCounter = document.getElementById('char-counter');
            const provinceSelect = document.getElementById('province');
            const copyrightYear = document.getElementById('copyright-year');
            const showFormBtn = document.getElementById('show-form-btn');
            const showStatsBtn = document.getElementById('show-stats-btn');
            const formSection = document.getElementById('form-section');
            const statsSection = document.getElementById('stats-section');
            const captchaCheckbox = document.getElementById('captcha');
            const configErrorBanner = document.getElementById('config-error-banner');
            const mainContent = document.getElementById('main-content');

            // Modals
            const verificationModal = document.getElementById('verification-modal');
            const verifyBtn = document.getElementById('verify-btn');
            const cancelVerifyBtn = document.getElementById('cancel-verify-btn');
            const verificationCodeInput = document.getElementById('verification-code-input');
            const timerDisplay = document.getElementById('timer');
            const verificationCodeDisplay = document.getElementById('verification-code-display');
            
            const messageModal = document.getElementById('message-modal');
            const messageText = document.getElementById('message-text');
            const messageIcon = document.getElementById('message-icon');
            const closeMessageBtn = document.getElementById('close-message-btn');
            
            const reportModal = document.getElementById('report-modal');
            const reportContent = document.getElementById('report-content');
            const copyReportBtn = document.getElementById('copy-report-btn');
            const closeReportBtn = document.getElementById('close-report-btn');

            // Stats elements
            const totalParticipantsSpan = document.getElementById('total-participants');
            const tagCloudContainer = document.getElementById('tag-cloud');
            const generateReportBtn = document.getElementById('generate-report-btn');

            // --- STATE & CONFIG ---
            const provinces = [
                'آذربایجان شرقی', 'آذربایجان غربی', 'اردبیل', 'اصفهان', 'البرز', 'ایلام', 'بوشهر', 'تهران', 'چهارمحال و بختیاری', 'خراسان جنوبی', 'خراسان رضوی', 'خراسان شمالی', 'خوزستان', 'زنجان', 'سمنان', 'سیستان و بلوچستان', 'فارس', 'قزوین', 'قم', 'کردستان', 'کرمان', 'کرمانشاه', 'کهگیلویه و بویراحمد', 'گلستان', 'گیلان', 'لرستان', 'مازندران', 'مرکزی', 'هرمزگان', 'همدان', 'یزد', 'خارج از ایران'
            ];
            
            const verificationCodes = [
                "815328", "226179", "335804", "749216", "953817", "118432", "674290", "501683", "429715", "882541",
                "763902", "148576", "259340", "367185", "478291", "589342", "691453", "702564", "813675", "924786",
                "135897", "246908", "357019", "468120", "579231", "680342", "791453", "802564", "913675", "124786",
                "235897", "346908", "457019", "568120", "679231", "780342", "891453", "902564", "113675", "224786",
                "335897", "446908", "557019", "668120", "779231", "880342", "991453", "102564", "213675", "324786",
                "435897", "546908", "657019", "768120", "879231", "980342", "191453", "202564", "313675", "424786",
                "535897", "646908", "757019", "868120", "979231", "180342", "291453", "302564", "413675", "524786",
                "635897", "746908", "857019", "968120", "179231", "280342", "391453", "402564", "513675", "624786",
                "735897", "846908", "957019", "168120", "279231", "380342", "491453", "502564", "613675", "724786",
                "835897", "946908", "157019", "268120", "379231", "480342", "591453", "602564", "713675", "824786"
            ];

            let verificationTimer;
            let currentCode = '';
            let damageChartInstance, provinceChartInstance, sentimentChartInstance;
            let allSubmissionsData = []; 
            let db, auth;
            
            // --- INITIALIZATION ---
            function init() {
                if (!firebaseConfig || firebaseConfig.apiKey.includes("YOUR_")) { // Updated check
                    configErrorBanner.classList.remove('hidden');
                    mainContent.style.paddingTop = '8rem'; 
                    const submitBtn = form.querySelector('button[type="submit"]');
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'پیکربندی پایگاه داده الزامی است';
                    submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    generateReportBtn.disabled = true;
                    generateReportBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    return; 
                }

                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    signInAnonymously(auth).catch((error) => {
                        console.error("Anonymous sign-in failed:", error);
                        showMessage('error', `خطا در احراز هویت: ${error.message}`);
                    });
                    onAuthStateChanged(auth, (user) => { if (user) { console.log("User is signed in anonymously with uid:", user.uid); } else { console.log("User is signed out."); } });
                } catch (e) {
                    console.error("Firebase Initialization Error: ", e);
                    showMessage('error', `خطای شدید در اتصال به پایگاه داده: ${e.message}`);
                    return;
                }

                provinces.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p;
                    option.textContent = p;
                    provinceSelect.appendChild(option);
                });
                provinceSelect.value = 'تهران';
                copyrightYear.textContent = new Date().getFullYear();
                setupFirestoreListener();
            };

            // --- EVENT LISTENERS ---
            opinionTextarea.addEventListener('input', () => {
                charCounter.textContent = `${opinionTextarea.value.length} / 2500`;
            });
            form.addEventListener('submit', handleFormSubmit);
            showFormBtn.addEventListener('click', () => {
                statsSection.classList.add('hidden');
                formSection.classList.remove('hidden');
                setActiveNav(showFormBtn);
            });
            showStatsBtn.addEventListener('click', () => {
                formSection.classList.add('hidden');
                statsSection.classList.remove('hidden');
                setActiveNav(showStatsBtn);
            });
            cancelVerifyBtn.addEventListener('click', closeVerificationModal);
            verifyBtn.addEventListener('click', handleVerification);
            closeMessageBtn.addEventListener('click', () => messageModal.classList.add('hidden'));
            generateReportBtn.addEventListener('click', handleGenerateReport);
            closeReportBtn.addEventListener('click', () => reportModal.classList.add('hidden'));
            copyReportBtn.addEventListener('click', () => {
                const textarea = document.createElement('textarea');
                textarea.value = reportContent.innerText;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showMessage('success', 'متن گزارش کپی شد!');
                } catch (err) {
                    showMessage('error', 'کپی کردن با خطا مواجه شد.');
                }
                document.body.removeChild(textarea);
            });
            
            // --- FUNCTIONS ---

            function setActiveNav(activeButton) {
                [showFormBtn, showStatsBtn].forEach(btn => {
                    btn.classList.remove('bg-purple-600');
                    btn.classList.add('bg-gray-700');
                });
                activeButton.classList.remove('bg-gray-700');
                activeButton.classList.add('bg-purple-600');
            }
            
            function showMessage(type, text) {
                messageText.textContent = text;
                messageIcon.innerHTML = type === 'success'
                    ? `<svg class="w-16 h-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
                    : `<svg class="w-16 h-16 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                messageModal.classList.remove('hidden');
            }

            async function handleFormSubmit(e) {
                e.preventDefault();
                if (sessionStorage.getItem('voted')) { showMessage('error', 'شما قبلاً در این نظرسنجی شرکت کرده‌اید.'); return; }
                if (!captchaCheckbox.checked) { showMessage('error', 'لطفاً تأیید کنید که ربات نیستید.'); return; }
                const email = new FormData(form).get('email');
                if (!email) { showMessage('error', 'وارد کردن ایمیل الزامی است.'); return; }
                
                currentCode = verificationCodes[Math.floor(Math.random() * verificationCodes.length)];
                
                verificationCodeDisplay.textContent = currentCode;
                verificationModal.classList.remove('hidden');
                startTimer(300);
            }

            function handleVerification() {
                clearInterval(verificationTimer);
                if (verificationCodeInput.value === currentCode) {
                    saveDataToFirestore();
                } else {
                    showMessage('error', 'کد وارد شده صحیح نیست. لطفاً دوباره تلاش کنید.');
                    closeVerificationModal();
                }
            }

            async function saveDataToFirestore() {
                const formData = new FormData(form);
                const data = {
                    jobField: formData.get('job-field'), damageLevel: formData.get('damage-level'),
                    filteringImpact: formData.get('filtering-impact'), province: formData.get('province'),
                    opinion: formData.get('opinion'), createdAt: serverTimestamp()
                };
                try {
                    if (!db) throw new Error("Firestore is not initialized.");
                    await addDoc(collection(db, "submissions"), data);
                    sessionStorage.setItem('voted', 'true');
                    closeVerificationModal();
                    showMessage('success', 'نظر شما با موفقیت ثبت شد. از مشارکت شما سپاسگزاریم.');
                    form.reset();
                    charCounter.textContent = '0 / 2500';
                    captchaCheckbox.checked = false;
                } catch (e) {
                    console.error("Error adding document: ", e);
                    showMessage('error', 'خطایی در ثبت اطلاعات رخ داد.');
                    closeVerificationModal();
                }
            }

            function closeVerificationModal() {
                clearInterval(verificationTimer);
                verificationModal.classList.add('hidden');
                verificationCodeInput.value = '';
            }

            function startTimer(duration) {
                let timer = duration, minutes, seconds;
                verificationTimer = setInterval(() => {
                    minutes = parseInt(timer / 60, 10);
                    seconds = parseInt(timer % 60, 10);
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    timerDisplay.textContent = `${minutes}:${seconds}`;
                    if (--timer < 0) {
                        clearInterval(verificationTimer);
                        showMessage('error', 'زمان شما به پایان رسید. لطفاً دوباره تلاش کنید.');
                        closeVerificationModal();
                    }
                }, 1000);
            }

            function setupFirestoreListener() {
                if (!db) { console.error("Firestore not available for listener."); return; }
                const q = collection(db, "submissions");
                onSnapshot(q, (querySnapshot) => {
                    allSubmissionsData = [];
                    querySnapshot.forEach((doc) => allSubmissionsData.push(doc.data()));
                    updateStatistics(allSubmissionsData);
                });
            }

            function updateStatistics(data) {
                totalParticipantsSpan.textContent = data.length;
                generateReportBtn.disabled = data.length === 0;

                if (data.length === 0) {
                    renderDamageChart({});
                    renderProvinceChart({});
                    renderSentimentChart({ positive: 0, negative: 0, neutral: 0 });
                    tagCloudContainer.innerHTML = '<p class="text-gray-500">داده‌ای برای نمایش وجود ندارد.</p>';
                    return;
                };

                const damageCounts = { 'کم': 0, 'متوسط': 0, 'زیاد': 0, 'بسیار زیاد': 0 };
                const provinceCounts = {};
                const allOpinions = [];

                data.forEach(item => {
                    if (item.damageLevel in damageCounts) damageCounts[item.damageLevel]++;
                    if (item.province) provinceCounts[item.province] = (provinceCounts[item.province] || 0) + 1;
                    if (item.opinion) allOpinions.push(item.opinion);
                });

                renderDamageChart(damageCounts);
                renderProvinceChart(provinceCounts);
                renderTagCloud(allOpinions.join(' '));
                analyzeSentiments(allOpinions);
            }

            function renderDamageChart(data) {
                const ctx = document.getElementById('damage-chart').getContext('2d');
                if (damageChartInstance) damageChartInstance.destroy();
                damageChartInstance = new Chart(ctx, { type: 'pie', data: { labels: Object.keys(data), datasets: [{ label: 'میزان خسارت', data: Object.values(data), backgroundColor: ['rgba(59, 130, 246, 0.7)','rgba(234, 179, 8, 0.7)','rgba(239, 68, 68, 0.7)','rgba(147, 51, 234, 0.7)'], borderColor: ['#3B82F6','#EAB308','#EF4444','#9333EA'], borderWidth: 1.5, hoverOffset: 8 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: '#d1d5db', font: { size: 12 } } } } } });
            }
            function renderProvinceChart(data) {
                const sortedProvinces = Object.entries(data).sort(([,a],[,b]) => b-a).slice(0, 10);
                const ctx = document.getElementById('province-chart').getContext('2d');
                if (provinceChartInstance) provinceChartInstance.destroy();
                provinceChartInstance = new Chart(ctx, { type: 'bar', data: { labels: sortedProvinces.map(item => item[0]), datasets: [{ label: 'تعداد', data: sortedProvinces.map(item => item[1]), backgroundColor: 'rgba(59, 130, 246, 0.6)', borderColor: '#3B82F6', borderWidth: 1, borderRadius: 4 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: '#d1d5db' } }, x: { ticks: { color: '#d1d5db' } } }, plugins: { legend: { display: false } } } });
            }
            function renderTagCloud(text) {
                 const persianStopWords = ['و', 'در', 'به', 'از', 'که', 'این', 'را', 'با', 'است', 'برای', 'تا', 'هم', 'آن', 'یا', 'یک', 'بر', 'من', 'تو', 'او', 'ما', 'شما', 'ایشان', 'هر', 'همه', 'دیگر', 'نیز', 'خود', 'باید', 'نباید', 'اگر', 'اما', 'ولی', 'چون', 'تا', 'حتی', 'فقط', 'کنند', 'کنم', 'کنه', 'شده', 'میشه', 'باشه', 'کرد', 'بود', 'شد', 'نیست', 'هست'];
                const words = text.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()؟]/g,"").split(/\s+/);
                const freqMap = {};
                words.forEach(word => { if(word.length > 2 && !persianStopWords.includes(word)) freqMap[word] = (freqMap[word] || 0) + 1; });
                const sortedWords = Object.entries(freqMap).sort(([,a],[,b]) => b-a).slice(0, 40);
                if (sortedWords.length === 0) { tagCloudContainer.innerHTML = '<p class="text-gray-500">نظری ثبت نشده.</p>'; return; }
                const maxFreq = sortedWords[0][1]; const minFreq = sortedWords[sortedWords.length - 1][1];
                tagCloudContainer.innerHTML = '';
                const colors = ['text-purple-400', 'text-yellow-400', 'text-red-400', 'text-blue-400'];
                sortedWords.forEach(([word, freq], index) => {
                    const tag = document.createElement('span');
                    const size = 1 + (freq - minFreq) / (maxFreq - minFreq || 1) * 1.2;
                    tag.textContent = word;
                    tag.className = `font-bold p-1 transition-all hover:opacity-100 cursor-default ${colors[index % colors.length]}`;
                    tag.style.fontSize = `${size}rem`;
                    tag.style.opacity = 0.6 + (size - 1) * 0.4;
                    tagCloudContainer.appendChild(tag);
                });
            }
            function renderSentimentChart(data) {
                 const ctx = document.getElementById('sentiment-chart').getContext('2d');
                if (sentimentChartInstance) sentimentChartInstance.destroy();
                sentimentChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: ['منفی', 'مثبت', 'خنثی'], datasets: [{ label: 'احساسات', data: [data.negative, data.positive, data.neutral], backgroundColor: ['rgba(239, 68, 68, 0.7)','rgba(34, 197, 94, 0.7)','rgba(107, 114, 128, 0.7)'], borderColor: ['#EF4444','#22C55E','#6B7280'], borderWidth: 1.5, hoverOffset: 8 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: '#d1d5db', font: { size: 12 } } } } } });
            }
            
            const GEMINI_API_KEY = ""; // No key needed when run inside the environment
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
            
            async function analyzeSentiments(comments) {
                if (comments.length === 0) {
                     renderSentimentChart({ positive: 0, negative: 0, neutral: 0 });
                     return;
                }
                const prompt = `Analyze the sentiment of the following array of Persian comments about internet filtering in Iran. Classify the overall sentiment of the collection. Return a single JSON object with the keys "positive", "negative", and "neutral", containing the count for each category. Comments: ${JSON.stringify(comments.slice(0, 50))}`;

                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: { type: "OBJECT", properties: { positive: { type: "NUMBER" }, negative: { type: "NUMBER" }, neutral: { type: "NUMBER" } } }
                    }
                };
                
                try {
                    const response = await fetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    const sentimentData = JSON.parse(result.candidates[0].content.parts[0].text);
                    renderSentimentChart(sentimentData);
                } catch (error) {
                    console.error("Sentiment analysis failed:", error);
                    renderSentimentChart({ positive: 0, negative: 0, neutral: 0 });
                }
            }

            async function handleGenerateReport() {
                if (allSubmissionsData.length === 0) { showMessage('error', 'هنوز داده‌ای برای تولید گزارش وجود ندارد.'); return; }

                const btnText = document.getElementById('btn-text');
                const btnSpinner = document.getElementById('btn-spinner');
                generateReportBtn.disabled = true;
                btnText.textContent = 'در حال پردازش...';
                btnSpinner.classList.remove('hidden');

                const statsSummary = `Total Participants: ${totalParticipantsSpan.textContent}. Damage Distribution: ${JSON.stringify(damageChartInstance.data.datasets[0].data)} with labels ${JSON.stringify(damageChartInstance.data.labels)}. Top Provinces: ${JSON.stringify(provinceChartInstance.data.labels)}.`;
                const sampleComments = allSubmissionsData.map(s => s.opinion).filter(Boolean).slice(0, 20);
                
                const prompt = `You are a professional policy analyst and reporter. Your task is to write a formal press release in PERSIAN based on the provided survey data about the "Impact of Internet Restrictions on Online Businesses in Iran". Data: - Statistical Summary: ${statsSummary} - Sample User Comments: ${JSON.stringify(sampleComments)}. Please structure the report with a Title, Introduction, Key Findings (narrative format), Voice of the Businesses (summarize sentiment and quote themes), and a Conclusion. The final output must be only the press release text in Persian, well-formatted with Markdown for headings.`;
                
                const payload = { contents: [{ parts: [{ text: prompt }] }] };

                try {
                     reportModal.classList.remove('hidden');
                     reportContent.innerText = 'در حال ارتباط با هوش مصنوعی و تولید متن گزارش... لطفاً چند لحظه صبر کنید.';

                    const response = await fetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                     if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0].content.parts[0].text) {
                        reportContent.innerText = result.candidates[0].content.parts[0].text;
                    } else {
                         throw new Error("No content received from Gemini.");
                    }
                } catch(error) {
                    console.error("Report generation failed:", error);
                    reportContent.innerText = `متأسفانه در تولید گزارش خطایی رخ داد.\n\nجزئیات خطا: ${error.message}\n\nلطفاً دوباره تلاش کنید.`;
                } finally {
                    generateReportBtn.disabled = false;
                    btnText.textContent = '✨ ایجاد پیش‌نویس گزارش رسمی';
                    btnSpinner.classList.add('hidden');
                }
            }
            
            // --- LET'S GO ---
            init();
        });
    </script>
</body>
</html>
